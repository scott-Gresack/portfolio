<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Define character encoding -->
  <meta charset="UTF-8" />
  <!-- Ensure responsive design -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tool-specific title -->
  <title>Alloy Flattened Payload Analyzer | Scott Gresack Portfolio</title>
  <!-- SEO description for the tool -->
  <meta name="description" content="Analyze flattened Adobe Alloy event payloads with Scott Gresack's tool. Parse JSON, view dynamic tables, filter data, and download results." />
  <!-- Relevant keywords -->
  <meta name="keywords" content="Martech, Adobe Alloy, Adobe Experience Platform, AEP, Web SDK, XDM, Analytics, Tag Management, Data Layer, Scott Gresack" />
  <!-- Author -->
  <meta name="author" content="Scott Gresack" />
  <!-- Allow indexing -->
  <meta name="robots" content="index, follow" />
  <!-- Canonical URL -->
  <link rel="canonical" href="https://scott-gresack.github.io/portfolio/tool2.html" />
  <!-- Google site verification -->
  <meta name="google-site-verification" content="LTi0sO_AWGNd4v7uJivsQWdkhrGDBDX2uLFTSIFNgbs" />

  <!-- Open Graph tags -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://scott-gresack.github.io/portfolio/tool2.html" />
  <meta property="og:title" content="Alloy Flattened Payload Analyzer | Scott Gresack Portfolio" />
  <meta property="og:description" content="Explore Scott Gresack's Alloy Flattened Payload Analyzer for parsing and analyzing flattened Adobe Alloy event payloads with dynamic tables, filtering, and JSON export." />
  <meta property="og:image" content="https://scott-gresack.github.io/portfolio/assets/preview-image.png" />

  <!-- Twitter Card tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Alloy Flattened Payload Analyzer | Scott Gresack Portfolio" />
  <meta name="twitter:description" content="Use Scott Gresack's tool to analyze flattened Adobe Alloy payloads, featuring dynamic tables, filtering, and JSON download capabilities." />
  <meta name="twitter:image" content="https://scott-gresack.github.io/portfolio/assets/preview-image.png" />

  <!-- Schema.org structured data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Person",
    "name": "Scott Gresack",
    "url": "https://scott-gresack.github.io/portfolio/",
    "sameAs": ["https://www.linkedin.com/in/scottgresack/"],
    "jobTitle": "Martech Engineer | AEP + CDP Expert",
    "worksFor": {
      "@type": "Organization",
      "name": "CVS Health"
    },
    "knowsAbout": [
      "Adobe Web SDK",
      "Tealium iQ",
      "Adobe Experience Platform",
      "Customer Data Platform",
      "Martech Architecture",
      "Tag Management",
      "Digital Analytics",
      "Identity Resolution",
      "Real-Time Personalization",
      "XDM Schema Design"
    ]
  }
  </script>

  <!-- PostHog Analytics -->
  <script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init bs ws ge fs capture De calculateEventProperties $s register register_once register_for_session unregister unregister_for_session Is getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty xs Ss createPersonProfile Es gs opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing ys debug ks getPageViewId captureTraceFeedback captureTraceMetric".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_poY0XlVu6WBmOsIKW4OwRT60oDXKjJrMhPz1tqhvK6U', {
        api_host: 'https://us.i.posthog.com',
        person_profiles: 'always'
    })
  </script>

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <!-- Tailwind CSS (CDN for development; see note for production) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Note: For production, install Tailwind via npm and bundle (https://tailwindcss.com/docs/installation) -->
  <!-- Vue.js for navigation -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y8617TLMYK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag("js", new Date());
    gtag("config", "G-Y8617TLMYK", { anonymize_ip: true });
  </script>
  <!-- Microsoft Clarity -->
  <script>
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "pmp4efispy");
  </script>
  <!-- Piwik Pro -->
  <script type="text/javascript">
    (function(window, document, dataLayerName, id) {
      window[dataLayerName]=window[dataLayerName]||[],window[dataLayerName].push({start:(new Date).getTime(),event:"stg.start"});
      var scripts=document.getElementsByTagName('script')[0],tags=document.createElement('script');
      var qP=[];dataLayerName!=="dataLayer"&&qP.push("data_layer_name="+dataLayerName);
      var qPString=qP.length>0?("?"+qP.join("&")):"";
      tags.async=!0;
      tags.src="https://scott-gresack.containers.piwik.pro/40c8a729-ebc6-4dfe-98be-6617064e43a9.js"+qPString;
      scripts.parentNode.insertBefore(tags,scripts);
      !function(a,n,i){a[n]=a[n]||{};for(var c=0;c<i.length;c++)!function(i){a[n][i]=a[n][i]||{},a[n][i].api=a[n][i].api||function(){var a=[].slice.call(arguments,0);"string"==typeof a[0]&&window[dataLayerName].push({event:n+"."+i+":"+a[0],parameters:[].slice.call(arguments,1)})}}(i[c])}(window,"ppms",["tm","cm"]);
    })(window, document, 'dataLayer', '40c8a729-ebc6-4dfe-98be-6617064e43a9');
  </script>
  <!-- Inline CSS -->
  <style>
    textarea {
      font-family: 'Courier New', Courier, monospace;
      resize: vertical;
    }
    pre {
      max-height: 300px;
      overflow-y: auto;
    }
    .nested-indent {
      margin-left: 1rem;
    }
    .error-message {
      background: #fee2e2;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    .success-message {
      background: #d1fae5;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    /* Responsive table wrapper */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    /* Table styling */
    #payloadTable {
      min-width: 100%;
      table-layout: auto;
    }
    #payloadTable th, #payloadTable td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 100px;
      max-width: 300px;
      padding: 0.75rem;
    }
    #payloadTable th:first-child, #payloadTable td:first-child { /* Index column */
      min-width: 60px;
      max-width: 100px;
    }
    /* Nested content */
    #payloadTable pre {
      white-space: pre-wrap;
      max-height: 200px;
    }
    /* Mobile adjustments */
    @media (max-width: 640px) {
      #payloadTable th, #payloadTable td {
        font-size: 0.75rem;
        padding: 0.5rem;
        max-width: 150px;
      }
      #payloadTable th:first-child, #payloadTable td:first-child { /* Index column */
        max-width: 80px;
      }
    }
  </style>
</head>
<body class="font-sans bg-gray-100 text-gray-800">
  <!-- Navigation bar -->
  <div id="nav-app">
    <header class="bg-white shadow sticky top-0 z-50">
      <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between text-sm font-medium text-gray-800">
        <div>Scott Gresack</div>
        <div class="space-x-2 sm:space-x-4">
          <button @click="navigate('about')" :class="{ 'border-b-2 border-blue-500 font-semibold': view === 'about' }" class="hover:text-blue-500">About</button>
          <button @click="navigate('contact')" :class="{ 'border-b-2 border-blue-500 font-semibold': view === 'contact' }" class="hover:text-blue-500">Contact</button>
          <button @click="navigate('tools')" :class="{ 'border-b-2 border-blue-500 font-semibold': view === 'tools' }" class="hover:text-blue-500">Tools</button>
          <button @click="navigate('diagrams')" :class="{ 'border-b-2 border-blue-500 font-semibold': view === 'diagrams' }" class="hover:text-blue-500">Diagrams</button>
          <a href="https://scott-gresack.github.io/portfolio/tool2.html" class="hover:text-blue-500">Another Tool</a>
        </div>
      </nav>
    </header>
  </div>

  <!-- Main content -->
  <main class="mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full max-w-7xl">
    <section class="bg-white rounded-lg shadow-md p-4 sm:p-6">
      <h1 class="text-xl sm:text-2xl font-semibold mb-4">Alloy Flattened Payload Analyzer</h1>
      <!-- Business Value -->
      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
        <h2 class="text-lg font-medium mb-3">Business Value</h2>
        <p class="mb-2">The Alloy Flattened Payload Analyzer enhances Adobe Alloy implementations by providing a user-friendly interface to inspect, filter, and export flattened event payloads. It streamlines Martech workflows by:</p>
        <ul class="list-disc pl-5">
          <li><strong>Simplifying Debugging</strong>: Quickly identify issues in flattened data layers with a dynamic table view.</li>
          <li><strong>Ensuring Data Accuracy</strong>: Validate flattened XDM fields for compliance with comprehensive column coverage.</li>
          <li><strong>Facilitating Collaboration</strong>: Export flattened payloads as JSON to share with teams, improving communication.</li>
          <li><strong>Real-Time Analysis</strong>: Automatically capture flattened payloads from sessionStorage for immediate inspection during AEP testing.</li>
        </ul>
      </div>
      <!-- Instructions -->
      <div class="bg-gray-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
        <h2 class="text-lg font-medium mb-3">Instructions</h2>
        <h3 class="text-md font-medium mb-2">Setup Alloy Flattening Script</h3>
        <ol class="pl-5 list-decimal mb-4">
          <li>Copy the Alloy flattening script below:
            <div class="relative mt-2 mb-2">
              <pre class="bg-gray-800 text-white p-4 rounded overflow-x-auto"><code id="alloyScript">(function () {
  const STORAGE_KEY = 'flattenedAlloyEvents';

  function flatten(obj, prefix = '', res = {}) {
    for (let key in obj) {
      if (!obj.hasOwnProperty(key)) continue;
      const value = obj[key];
      const path = prefix ? `${prefix}.${key}` : key;
      if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
        flatten(value, path, res);
      } else {
        res[path] = value;
      }
    }
    return res;
  }

  window.__alloyMonitors = window.__alloyMonitors || [];

  if (!window.__alloyMonitors.some(m => m.__isFlattenMonitor)) {
    window.__alloyMonitors.push({
      __isFlattenMonitor: true,
      onBeforeNetworkRequest(data) {
        try {
          const events = data?.payload?.events;
          if (!Array.isArray(events) || !events.length) return;

          events.forEach(event => {
            const flatXDM = event.xdm ? flatten(event.xdm, 'xdm') : {};
            const flatData = event.data ? flatten(event.data, 'data') : {};
            const combined = { ...flatXDM, ...flatData };

            const styleHeader = 'background:#6366f1;color:#fff;font-weight:bold;padding:2px 6px;border-radius:4px;';
            const styleXDM = 'color:#3b82f6;font-weight:bold;';
            const styleData = 'color:#10b981;font-weight:bold;';
            const styleCombined = 'color:#f97316;font-weight:bold;';

            console.log('%c[AlloyMonitor] Flattened Event Detected', styleHeader);
            if (Object.keys(flatXDM).length)
              console.log('%c↳ Flattened XDM:', styleXDM, flatXDM);
            if (Object.keys(flatData).length)
              console.log('%c↳ Flattened Data:', styleData, flatData);

            console.log('%c↳ Combined Payload:', styleCombined, combined);

            const stored = sessionStorage.getItem(STORAGE_KEY);
            const prev = stored ? JSON.parse(stored) : [];
            prev.push(combined);
            sessionStorage.setItem(STORAGE_KEY, JSON.stringify(prev));
          });
        } catch (err) {
          console.warn('[AlloyMonitor] Error flattening event payload:', err);
        }
      },
      onCommandResolved() {},
      onNetworkResponse() {},
      onNetworkError() {}
    });

    console.info('%c[AlloyMonitor] Payload flattener active. Capturing and storing in sessionStorage.', 'color:#4ade80;font-weight:bold;');

    // Display stored events in console.table after 5 seconds
    setTimeout(() => {
      const stored = sessionStorage.getItem(STORAGE_KEY);
      const events = stored ? JSON.parse(stored) : [];
      if (events.length > 0) {
        console.log('%c[AlloyMonitor] Stored Flattened Events:', 'background:#8b5cf6;color:#fff;font-weight:bold;padding:2px 6px;border-radius:4px;');
        console.table(events);
      } else {
        console.log('%c[AlloyMonitor] No flattened events stored yet', 'color:#f59e0b;font-weight:bold;');
      }
    }, 5000);
  }
})();
</code></pre>
              <button onclick="copyScript()" class="absolute top-2 right-2 bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-600" aria-label="Copy script to clipboard">Copy</button>
            </div>
          </li>
          <li>Open your browser's developer tools (F12 or right-click > Inspect) and go to the Console tab.</li>
          <li>Paste the script into the console and press Enter to run it. The console will show "[AlloyMonitor] Payload flattener active" if successful.</li>
          <li>Verify the script is capturing events by checking for messages like "[AlloyMonitor] Flattened Event Detected" and a summary table after 5 seconds.</li>
          <li>Events are stored in sessionStorage under the key <code>flattenedAlloyEvents</code>. To view, go to Application > Session Storage > [your domain] > <code>flattenedAlloyEvents</code> in developer tools.</li>
        </ol>
        <h3 class="text-md font-medium mb-2">Analyze Flattened Payloads</h3>
        <ol class="pl-5 list-decimal">
          <li>Ensure the Alloy flattening script is running (check console for captured payloads).</li>
          <li>Payloads are auto-loaded from sessionStorage, or paste a JSON array of flattened events into the textarea.</li>
          <li>Click "Parse Payloads" to analyze or "Refresh Payloads" to update from sessionStorage.</li>
          <li>Use the filter to search for specific fields or values.</li>
          <li>Click "Download as JSON" to save the flattened payloads.</li>
        </ol>
      </div>
      <!-- Feedback messages -->
      <div id="errorMessage" class="hidden error-message mb-4"></div>
      <div id="successMessage" class="hidden success-message mb-4"></div>
      <div id="loadingIndicator" class="hidden text-blue-600 font-semibold mb-4">Processing...</div>
      <!-- JSON input -->
      <textarea id="payloadInput" class="w-full min-h-[150px] border border-gray-300 rounded p-3 mb-4" placeholder="Paste flattened Alloy event payloads JSON array here or auto-load from sessionStorage..." aria-label="JSON payload input"></textarea>
      <!-- Action buttons -->
      <div class="flex flex-col sm:flex-row sm:space-x-4 mb-4 space-y-2 sm:space-y-0">
        <button onclick="parsePayloads()" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 w-full sm:w-auto" aria-label="Parse JSON payloads">Parse Payloads</button>
        <button onclick="refreshPayloads()" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 w-full sm:w-auto" aria-label="Refresh payloads from sessionStorage">Refresh Payloads</button>
        <button onclick="downloadJSON()" class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 w-full sm:w-auto hidden" id="downloadBtn" aria-label="Download JSON file">Download as JSON</button>
      </div>
      <!-- Filter input -->
      <input type="text" id="filterInput" class="p-2 w-full sm:max-w-xs border border-gray-300 rounded mb-4" placeholder="Filter by field or value..." aria-label="Filter table data" />
      <!-- Payload table -->
      <div class="table-wrapper">
        <table id="payloadTable" class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100"></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- JavaScript logic -->
  <script>
    // Initialize Vue.js for navigation
    const { createApp } = Vue;
    createApp({
      data() {
        return { view: 'tools' };
      },
      methods: {
        navigate(section) {
          this.view = section;
          trackNavigation(section);
          window.clarity('event', `navigation_${section}`);
          window.dataLayer.push({ event: 'ppms.cm:navigation', section });
          posthog.capture('navigation_click', { section });
        }
      }
    }).mount('#nav-app');

    // --- Alloy Flattened Payload Analyzer GA4 Enhanced Tracking ---

    // Tool loaded/session started (fires once at load)
    gtag('event', 'tool_loaded', {
      tool_name: 'Alloy Flattened Payload Analyzer',
      tool_version: '1.0.1',
      page_location: window.location.href
    });
    posthog.capture('tool_loaded', {
      tool_name: 'Alloy Flattened Payload Analyzer',
      tool_version: '1.0.1'
    });

    // Heartbeat for active engagement (fires every 30 seconds)
    setInterval(() => {
      gtag('event', 'tool_heartbeat', {
        tool_name: 'Alloy Flattened Payload Analyzer',
        timestamp: new Date().toISOString()
      });
      posthog.capture('tool_heartbeat', {
        tool_name: 'Alloy Flattened Payload Analyzer'
      });
    }, 30000);

    // Tracking functions
    function trackFlattenedPayloadsParsed(payloads, columnCount) {
      gtag('event', 'flattened_payloads_parsed', {
        payload_count: payloads.length,
        column_count: columnCount,
        event_types: Array.from(new Set(payloads.map(e => e['xdm.eventType'] || 'unknown'))).join(','),
        tool_name: 'Alloy Flattened Payload Analyzer'
      });
      window.clarity('event', 'flattened_payloads_parsed');
      window.dataLayer.push({
        event: 'ppms.cm:flattened_payloads_parsed',
        payload_count: payloads.length,
        column_count: columnCount
      });
      posthog.capture('flattened_payloads_parsed', {
        payload_count: payloads.length,
        column_count: columnCount,
        event_types: Array.from(new Set(payloads.map(e => e['xdm.eventType'] || 'unknown'))).join(',')
      });
    }

    function trackJsonDownload(payloads) {
      gtag('event', 'json_download', {
        payload_count: payloads.length,
        event_types: Array.from(new Set(payloads.map(e => e['xdm.eventType'] || 'unknown'))).join(','),
        tool_name: 'Alloy Flattened Payload Analyzer'
      });
      window.clarity('event', 'json_download');
      window.dataLayer.push({
        event: 'ppms.cm:json_download',
        payload_count: payloads.length
      });
      posthog.capture('json_download', {
        payload_count: payloads.length
      });
    }

    function trackScriptCopied() {
      gtag('event', 'script_copied', {
        tool_name: 'Alloy Flattened Payload Analyzer'
      });
      window.clarity('event', 'copy_script_success');
      window.dataLayer.push({ event: 'ppms.cm:copy_script', status: 'success' });
      posthog.capture('script_copied', {
        tool_name: 'Alloy Flattened Payload Analyzer'
      });
    }

    function trackFilterUsed(filter) {
      gtag('event', 'filter_used', {
        filter_value: filter,
        tool_name: 'Alloy Flattened Payload Analyzer'
      });
      window.clarity('event', 'filter_table');
      window.dataLayer.push({ event: 'ppms.cm:filter_table', filter_value: filter });
      posthog.capture('filter_used', { filter_value: filter });
    }

    function trackNavigation(section) {
      gtag('event', 'navigation_click', {
        section,
        tool_name: 'Alloy Flattened Payload Analyzer'
      });
      posthog.capture('navigation_click', { section });
    }

    function trackToolError(e) {
      gtag('event', 'tool_error', {
        error_type: e.name || 'Error',
        error_message: e.message || 'Unknown',
        tool_name: 'Alloy Flattened Payload Analyzer'
      });
      window.clarity('event', 'tool_error');
      window.dataLayer.push({
        event: 'ppms.cm:tool_error',
        error_type: e.name || 'Error',
        error_message: e.message || 'Unknown'
      });
      posthog.capture('tool_error', {
        error_type: e.name || 'Error',
        error_message: e.message || 'Unknown'
      });
    }

    // Debounce utility
    function debounce(fn, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    // Parse and render flattened payloads
    function parsePayloads() {
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const payloadInput = document.getElementById('payloadInput');
      errorMessage.classList.add('hidden');
      successMessage.classList.add('hidden');
      loadingIndicator.classList.remove('hidden');

      const input = payloadInput.value.trim();
      if (!input) {
        errorMessage.textContent = 'Error: Input is empty. Please paste a valid JSON array of flattened events.';
        errorMessage.classList.remove('hidden');
        gtag('event', 'parse_flattened_payloads', { status: 'failure', error: 'empty_input' });
        window.clarity('event', 'parse_flattened_payloads_failure');
        window.dataLayer.push({ event: 'ppms.cm:parse_flattened_payloads', status: 'failure', error: 'empty_input' });
        trackToolError({ name: 'Error', message: 'Empty input' });
        posthog.capture('parse_flattened_payloads_failure', { error: 'empty_input' });
        loadingIndicator.classList.add('hidden');
        return null;
      }

      try {
        let payloads = JSON.parse(input);
        // Convert single object to array if valid
        if (!Array.isArray(payloads) && typeof payloads === 'object' && payloads !== null) {
          payloads = [payloads];
        }
        if (!Array.isArray(payloads)) {
          throw new Error('Input must be a JSON array or a single object convertible to an array of flattened events');
        }
        if (payloads.length === 0) {
          throw new Error('Input array is empty. Please provide at least one flattened event.');
        }
        // Collect unique keys for columns
        const columns = ['index'];
        const uniqueKeys = new Set();
        payloads.forEach(event => {
          Object.keys(event).forEach(key => uniqueKeys.add(key));
        });
        columns.push(...Array.from(uniqueKeys).sort()); // Sort for consistent column order
        // Save to localStorage for persistence
        localStorage.setItem('flattenedAlloyEvents', JSON.stringify(payloads));
        document.getElementById('downloadBtn').classList.remove('hidden');
        renderTable(payloads, columns);
        successMessage.textContent = `Successfully parsed ${payloads.length} flattened events with ${columns.length - 1} unique fields.`;
        successMessage.classList.remove('hidden');
        trackFlattenedPayloadsParsed(payloads, columns.length);
        return payloads;
      } catch (e) {
        console.error('Parse error details:', e);
        errorMessage.textContent = e.name === 'SyntaxError'
          ? 'Invalid JSON syntax. Check for missing brackets, commas, or invalid characters and try again.'
          : `Error: ${e.message}. Ensure the input is a valid JSON array or object of flattened events.`;
        errorMessage.classList.remove('hidden');
        trackToolError(e);
        gtag('event', 'parse_flattened_payloads', { status: 'failure', error: e.name === 'SyntaxError' ? 'syntax_error' : e.message });
        window.clarity('event', 'parse_flattened_payloads_failure');
        window.dataLayer.push({
          event: 'ppms.cm:parse_flattened_payloads',
          status: 'failure',
          error: e.name === 'SyntaxError' ? 'syntax_error' : e.message
        });
        posthog.capture('parse_flattened_payloads_failure', { error: e.name === 'SyntaxError' ? 'syntax_error' : e.message });
        payloadInput.value = input; // Retain input on error
        return null;
      } finally {
        loadingIndicator.classList.add('hidden');
      }
    }

    // Refresh payloads from sessionStorage
    function refreshPayloads() {
      const key = 'flattenedAlloyEvents';
      const stored = sessionStorage.getItem(key);
      const payloadInput = document.getElementById('payloadInput');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      const loadingIndicator = document.getElementById('loadingIndicator');
      errorMessage.classList.add('hidden');
      successMessage.classList.add('hidden');
      loadingIndicator.classList.remove('hidden');

      if (!stored) {
        errorMessage.textContent = 'No flattened payloads found in sessionStorage. Ensure the Alloy flattening script is running.';
        errorMessage.classList.remove('hidden');
        gtag('event', 'refresh_flattened_payloads', { status: 'failure', error: 'no_payloads' });
        window.clarity('event', 'refresh_flattened_payloads_failure');
        window.dataLayer.push({ event: 'ppms.cm:refresh_flattened_payloads', status: 'failure', error: 'no_payloads' });
        trackToolError({ name: 'Error', message: 'No payloads in sessionStorage' });
        posthog.capture('refresh_flattened_payloads_failure', { error: 'no_payloads' });
        loadingIndicator.classList.add('hidden');
        return;
      }

      payloadInput.value = stored;
      parsePayloads();
      gtag('event', 'refresh_flattened_payloads', { status: 'success' });
      window.clarity('event', 'refresh_flattened_payloads_success');
      window.dataLayer.push({ event: 'ppms.cm:refresh_flattened_payloads', status: 'success' });
      posthog.capture('refresh_flattened_payloads_success');
      loadingIndicator.classList.add('hidden');
    }

    // Render table with dynamic columns
    function renderTable(events, columns) {
      const thead = document.querySelector('#payloadTable thead tr');
      const tbody = document.querySelector('#payloadTable tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';

      // Create table headers
      columns.forEach(col => {
        const th = document.createElement('th');
        th.className = 'border border-gray-300 p-3 text-left font-semibold';
        th.textContent = col;
        thead.appendChild(th);
      });

      // Create table rows
      events.forEach((event, index) => {
        const row = document.createElement('tr');
        columns.forEach(col => {
          const td = document.createElement('td');
          td.className = 'border border-gray-300 p-3';
          if (col === 'index') {
            td.textContent = index + 1;
          } else {
            td.textContent = event[col] !== undefined ? event[col] : '';
          }
          row.appendChild(td);
        });
        tbody.appendChild(row);
      });
    }

    // Filter table rows
    const filterTable = debounce(() => {
      const filter = document.getElementById('filterInput').value.toLowerCase();
      const rows = document.querySelectorAll('#payloadTable tbody tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
      });
      trackFilterUsed(filter);
    }, 300);

    // Download payloads as JSON
    function downloadJSON() {
      const input = document.getElementById('payloadInput').value;
      const payloads = parsePayloads();
      if (payloads) {
        const blob = new Blob([JSON.stringify(payloads, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'flattened_alloy_payloads.json';
        a.click();
        URL.revokeObjectURL(url);
        trackJsonDownload(payloads);
      }
    }

    // Copy script to clipboard
    function copyScript() {
      const scriptText = document.getElementById('alloyScript').textContent;
      navigator.clipboard.writeText(scriptText).then(() => {
        const successMessage = document.getElementById('successMessage');
        successMessage.textContent = 'Script copied to clipboard!';
        successMessage.classList.remove('hidden');
        setTimeout(() => successMessage.classList.add('hidden'), 3000);
        trackScriptCopied();
      }).catch(err => {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = 'Failed to copy script. Please select and copy manually.';
        errorMessage.classList.remove('hidden');
        console.error('Copy failed:', err);
        trackToolError(err);
        gtag('event', 'copy_script', { status: 'failure', error: err.message });
        window.clarity('event', 'copy_script_failure');
        window.dataLayer.push({ event: 'ppms.cm:copy_script', status: 'failure', error: err.message });
        posthog.capture('copy_script_failure', { error: err.message });
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      refreshPayloads();
      document.getElementById('filterInput').addEventListener('input', filterTable);
    });
  </script>
</body>
</html>
