<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Define character encoding -->
  <meta charset="UTF-8" />
  <!-- Ensure responsive design -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tool-specific title -->
  <title>Alloy Payload Analyzer | Scott Gresack Portfolio</title>
  <!-- SEO description for the tool -->
<script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init bs ws ge fs capture De calculateEventProperties $s register register_once register_for_session unregister unregister_for_session Is getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty xs Ss createPersonProfile Es gs opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing ys debug ks getPageViewId captureTraceFeedback captureTraceMetric".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_poY0XlVu6WBmOsIKW4OwRT60oDXKjJrMhPz1tqhvK6U', {
        api_host: 'https://us.i.posthog.com',
        person_profiles: 'always', // or 'always' to create profiles for anonymous users as well
    })
</script>
  <meta name="description" content="Analyze Adobe Alloy event payloads with Scott Gresack's tool. Parse JSON, view detailed tables, filter data, and download results." />
  <!-- Relevant keywords -->
  <meta name="keywords" content="Martech, Adobe Alloy, Adobe Experience Platform, AEP, Web SDK, XDM, Analytics, Tag Management, Data Layer, Scott Gresack" />
  <!-- Author -->
  <meta name="author" content="Scott Gresack" />
  <!-- Allow indexing -->
  <meta name="robots" content="index, follow" />
  <!-- Canonical URL -->
  <link rel="canonical" href="https://scott-gresack.github.io/portfolio/tool2.html" />
  <!-- Google site verification -->
  <meta name="google-site-verification" content="LTi0sO_AWGNd4v7uJivsQWdkhrGDBDX2uLFTSIFNgbs" />

  <!-- Open Graph tags -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://scott-gresack.github.io/portfolio/tool2.html" />
  <meta property="og:title" content="Alloy Payload Analyzer | Scott Gresack Portfolio" />
  <meta property="og:description" content="Explore Scott Gresack's Alloy Payload Analyzer for parsing and analyzing Adobe Alloy event payloads with interactive filtering and JSON export." />
  <meta property="og:image" content="https://scott-gresack.github.io/portfolio/assets/preview-image.png" />

  <!-- Twitter Card tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Alloy Payload Analyzer | Scott Gresack Portfolio" />
  <meta name="twitter:description" content="Use Scott Gresack's tool to analyze Adobe Alloy payloads, featuring dynamic tables, filtering, and JSON download capabilities." />
  <meta name="twitter:image" content="https://scott-gresack.github.io/portfolio/assets/preview-image.png" />

  <!-- Schema.org structured data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Person",
    "name": "Scott Gresack",
    "url": "https://scott-gresack.github.io/portfolio/",
    "sameAs": ["https://www.linkedin.com/in/scottgresack/"],
    "jobTitle": "Martech Engineer | AEP + CDP Expert",
    "worksFor": {
      "@type": "Organization",
      "name": "CVS Health"
    },
    "knowsAbout": [
      "Adobe Web SDK",
      "Tealium iQ",
      "Adobe Experience Platform",
      "Customer Data Platform",
      "Martech Architecture",
      "Tag Management",
      "Digital Analytics",
      "Identity Resolution",
      "Real-Time Personalization",
      "XDM Schema Design"
    ]
  }
  </script>

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <!-- Tailwind CSS (CDN for development; see note for production) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Note: For production, install Tailwind via npm and bundle (https://tailwindcss.com/docs/installation) -->
  <!-- Vue.js for navigation -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y8617TLMYK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag("js", new Date());
    gtag("config", "G-Y8617TLMYK", { anonymize_ip: true });
  </script>
  <!-- Microsoft Clarity -->
  <script>
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "pmp4efispy");
  </script>
  <!-- Piwik Pro -->
  <script type="text/javascript">
    (function(window, document, dataLayerName, id) {
      window[dataLayerName]=window[dataLayerName]||[],window[dataLayerName].push({start:(new Date).getTime(),event:"stg.start"});
      var scripts=document.getElementsByTagName('script')[0],tags=document.createElement('script');
      var qP=[];dataLayerName!=="dataLayer"&&qP.push("data_layer_name="+dataLayerName);
      var qPString=qP.length>0?("?"+qP.join("&")):"";
      tags.async=!0;
      tags.src="https://scott-gresack.containers.piwik.pro/40c8a729-ebc6-4dfe-98be-6617064e43a9.js"+qPString;
      scripts.parentNode.insertBefore(tags,scripts);
      !function(a,n,i){a[n]=a[n]||{};for(var c=0;c<i.length;c++)!function(i){a[n][i]=a[n][i]||{},a[n][i].api=a[n][i].api||function(){var a=[].slice.call(arguments,0);"string"==typeof a[0]&&window[dataLayerName].push({event:n+"."+i+":"+a[0],parameters:[].slice.call(arguments,1)})}}(i[c])}(window,"ppms",["tm","cm"]);
    })(window, document, 'dataLayer', '40c8a729-ebc6-4dfe-98be-6617064e43a9');
  </script>
  <!-- Inline CSS -->
  <style>
    textarea {
      font-family: 'Courier New', Courier, monospace;
      resize: vertical;
    }
    pre {
      max-height: 300px;
      overflow-y: auto;
    }
    .nested-indent {
      margin-left: 1rem;
    }
    .error-message {
      background: #fee2e2;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    .success-message {
      background: #d1fae5;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    /* Responsive table wrapper */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    /* Table styling */
    #payloadTable {
      min-width: 100%;
      table-layout: auto;
    }
    #payloadTable th, #payloadTable td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Responsive column widths */
    #payloadTable th:nth-child(1), #payloadTable td:nth-child(1) { /* Event Type */
      min-width: 120px;
      max-width: 200px;
    }
    #payloadTable th:nth-child(2), #payloadTable td:nth-child(2) { /* Timestamp */
      min-width: 140px;
      max-width: 220px;
    }
    #payloadTable th:nth-child(3), #payloadTable td:nth-child(3) { /* Page URL */
      min-width: 150px;
      max-width: 300px;
    }
    #payloadTable th:nth-child(4), #payloadTable td:nth-child(4) { /* Page Name */
      min-width: 120px;
      max-width: 200px;
    }
    #payloadTable th:nth-child(5), #payloadTable td:nth-child(5) { /* Interaction */
      min-width: 120px;
      max-width: 200px;
    }
    #payloadTable th:nth-child(6), #payloadTable td:nth-child(6) { /* Data */
      min-width: 100px;
      max-width: 250px;
    }
    #payloadTable th:nth-child(7), #payloadTable td:nth-child(7) { /* Full Payload */
      min-width: 100px;
      max-width: 250px;
    }
    /* Nested content */
    #payloadTable pre {
      white-space: pre-wrap;
      max-height: 200px;
    }
    /* Mobile adjustments */
    @media (max-width: 640px) {
      #payloadTable th, #payloadTable td {
        font-size: 0.75rem;
        padding: 0.5rem;
      }
      #payloadTable th:nth-child(3), #payloadTable td:nth-child(3),
      #payloadTable th:nth-child(4), #payloadTable td:nth-child(4),
      #payloadTable th:nth-child(5), #payloadTable td:nth-child(5) {
        max-width: 150px;
      }
      #payloadTable th:nth-child(6), #payloadTable td:nth-child(6),
      #payloadTable th:nth-child(7), #payloadTable td:nth-child(7) {
        max-width: 100px;
      }
    }
  </style>
</head>
<body class="font-sans bg-gray-100 text-gray-800">
  <!-- Navigation bar -->
  <div id="nav-app">
    <header class="bg-white shadow sticky top-0 z-50">
      <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between text-sm font-medium text-gray-800">
        <div>Scott Gresack</div>
        <div class="space-x-2 sm:space-x-4">
          <button @click="navigate('about')" :class="{ 'border-b-2 border-blue-500 font-semibold': view === 'about' }" class="hover:text-blue-500">About</button>
          <button @click="navigate('contact')" :class="{ 'border-b-2 border-blue-500 font-semibold': view === 'contact' }" class="hover:text-blue-500">Contact</button>
          <button @click="navigate('tools')" :class="{ 'border-b-2 border-blue-500 font-semibold': view === 'tools' }" class="hover:text-blue-500">Tools</button>
          <button @click="navigate('diagrams')" :class="{ 'border-b-2 border-blue-500 font-semibold': view === 'diagrams' }" class="hover:text-blue-500">Diagrams</button>
          <a href="https://scott-gresack.github.io/portfolio/tool2.html" class="hover:text-blue-500">Another Tool</a>
        </div>
      </nav>
    </header>
  </div>

  <!-- Main content -->
  <main class="mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full max-w-7xl">
    <section class="bg-white rounded-lg shadow-md p-4 sm:p-6">
      <h1 class="text-xl sm:text-2xl font-semibold mb-4">Alloy Payload Analyzer</h1>
      <!-- Business Value -->
      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
        <h2 class="text-lg font-medium mb-3">Business Value</h2>
        <p class="mb-2">The Alloy Payload Analyzer streamlines Adobe Alloy implementations by providing a user-friendly interface to inspect, filter, and export event payloads. It enhances Martech workflows by:</p>
        <ul class="list-disc pl-5">
          <li><strong>Accelerating Debugging</strong>: Quickly identify and resolve data layer issues with a clear, interactive table view.</li>
          <li><strong>Ensuring Data Quality</strong>: Validate XDM schema compliance, with highlighted web fields for easy verification.</li>
          <li><strong>Improving Collaboration</strong>: Export payloads as JSON to share with developers and analysts, reducing communication overhead.</li>
          <li><strong>Real-Time Monitoring</strong>: Capture payloads automatically via sessionStorage, enabling immediate analysis during AEP testing.</li>
        </ul>
      </div>
      <!-- Instructions -->
      <div class="bg-gray-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
        <h2 class="text-lg font-medium mb-3">Instructions</h2>
        <h3 class="text-md font-medium mb-2">Setup Alloy Monitor Script</h3>
        <ol class="pl-5 list-decimal mb-4">
          <li>Copy the Alloy monitor script below:
            <div class="relative mt-2 mb-2">
              <pre class="bg-gray-800 text-white p-4 rounded overflow-x-auto"><code id="alloyScript">(function () {
  const STORAGE_KEY = 'alloyEventPayloads';

  // Insert monitor if not present
  if (!window.__alloyMonitors) window.__alloyMonitors = [];
  if (!window.__alloyMonitors.some(m => m.__isScottMonitor)) {
    window.__alloyMonitors.push({
      __isScottMonitor: true,
      onBeforeNetworkRequest(data) {
        try {
          const events = data?.payload?.events;
          if (!Array.isArray(events) || !events.length) return;
          const stored = sessionStorage.getItem(STORAGE_KEY);
          let payloads = stored ? JSON.parse(stored) : [];
          payloads.push(events[0]);
          sessionStorage.setItem(STORAGE_KEY, JSON.stringify(payloads));
          console.info('%c[AlloyMonitor] Captured Alloy event:', 'color:#3b82f6;font-weight:bold', events[0]);
        } catch (err) {
          console.warn('[AlloyMonitor] Failed to capture event:', err);
        }
      },
      onCommandResolved() {},
      onNetworkResponse() {},
      onNetworkError() {}
    });
    console.info(
      '%c[AlloyMonitor] Monitor ACTIVE. Events stored in sessionStorage under "' +
      STORAGE_KEY +
      '".\nOpen the Analyzer tool and click "Refresh Payloads".',
      'background:#f1f5f9;color:#1e293b;font-weight:bold'
    );
  }

  // Polling log function every 6 seconds
  if (!window.__alloyMonitorSummaryInterval) {
    window.__alloyMonitorSummaryInterval = setInterval(() => {
      const raw = sessionStorage.getItem(STORAGE_KEY);
      if (!raw) {
        console.log(
          '%c[AlloyMonitor] No Alloy event payloads in sessionStorage.',
          'color:red;font-weight:bold'
        );
        return;
      }
      const events = JSON.parse(raw);
      const rows = events.map(ev => ({
        eventType: ev.eventType || ev.xdm?.eventType || 'N/A',
        timestamp: ev.xdm?.timestamp || 'N/A',
        url: ev.xdm?.web?.webPageDetails?.URL || 'N/A',
        pageName: eaev.xdm?.web?.webPageDetails?.name || 'N/A',
        interaction: ev.xdm?.web?.webInteraction?.name || ''
      }));
      console.log(
        '%c[AlloyMonitor] Event Summary Table (last ' + events.length + '):',
        'background:#e0e7ff;color:#312e81;font-weight:bold;padding:4px 12px;font-size:14px;'
      );
      console.table(rows);

      // Copy full array to clipboard for Analyzer use
      const json = JSON.stringify(events, null, 2);
      navigator.clipboard
        .writeText(json)
        .then(() =>
          console.log(
            '%c[AlloyMonitor] Full event array copied to clipboard for Alloy Analyzer.',
            'background:#22c55e;color:#fff;font-weight:bold;padding:2px 8px;'
          )
        )
        .catch(() =>
          console.log(
            '%c[AlloyMonitor] Could not copy to clipboard automatically. Please copy from below:',
            'color:orange;font-weight:bold;'
          )
        );
    }, 6000);
  }
})();
</code></pre>
              <button onclick="copyScript()" class="absolute top-2 right-2 bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-600" aria-label="Copy script to clipboard">Copy</button>
            </div>
          </li>
          <li>Open your browser's developer tools (F12 or right-click > Inspect) and go to the Console tab.</li>
          <li>Paste the script into the console and press Enter to run it. The console will show "[AlloyMonitor] Monitor ACTIVE" if successful.</li>
          <li>Verify the script is capturing events by checking for messages like "[AlloyMonitor] Captured Alloy event" and a summary table every 6 seconds.</li>
          <li>Events are stored in sessionStorage under the key <code>alloyEventPayloads</code>. To view, go to Application > Session Storage > [your domain] > <code>alloyEventPayloads</code> in developer tools.</li>
        </ol>
        <h3 class="text-md font-medium mb-2">Analyze Payloads</h3>
        <ol class="pl-5 list-decimal">
          <li>Ensure the Alloy monitor script is running (check console for captured payloads).</li>
          <li>Payloads are auto-loaded from sessionStorage, or paste a JSON array of events into the textarea.</li>
          <li>Click "Parse Payloads" to analyze or "Refresh Payloads" to update from sessionStorage.</li>
          <li>Use the filter to search for specific fields or values.</li>
          <li>Click "[Object]" links to expand/collapse nested details.</li>
          <li>Click "Download as JSON" to save the payloads.</li>
        </ol>
      </div>
      <!-- Feedback messages -->
      <div id="errorMessage" class="hidden error-message mb-4"></div>
      <div id="successMessage" class="hidden success-message mb-4"></div>
      <div id="loadingIndicator" class="hidden text-blue-600 font-semibold mb-4">Processing...</div>
      <!-- JSON input -->
      <textarea id="payloadInput" class="w-full min-h-[150px] border border-gray-300 rounded p-3 mb-4" placeholder="Paste Alloy event payloads JSON array here or auto-load from sessionStorage..." aria-label="JSON payload input"></textarea>
      <!-- Action buttons -->
      <div class="flex flex-col sm:flex-row sm:space-x-4 mb-4 space-y-2 sm:space-y-0">
        <button onclick="parsePayloads()" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 w-full sm:w-auto" aria-label="Parse JSON payloads">Parse Payloads</button>
        <button onclick="refreshPayloads()" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 w-full sm:w-auto" aria-label="Refresh payloads from sessionStorage">Refresh Payloads</button>
        <button onclick="downloadJSON()" class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 w-full sm:w-auto hidden" id="downloadBtn" aria-label="Download JSON file">Download as JSON</button>
      </div>
      <!-- Filter input -->
      <input type="text" id="filterInput" class="p-2 w-full sm:max-w-xs border border-gray-300 rounded mb-4" placeholder="Filter by field or value..." aria-label="Filter table data" />
      <!-- Payload table -->
      <div class="table-wrapper">
        <table id="payloadTable" class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 p-3 text-left font-semibold">Event Type</th>
              <th class="border border-gray-300 p-3 text-left font-semibold">Timestamp</th>
              <th class="border border-gray-300 p-3 text-left font-semibold">Page URL</th>
              <th class="border border-gray-300 p-3 text-left font-semibold">Page Name</th>
              <th class="border border-gray-300 p-3 text-left font-semibold">Interaction</th>
              <th class="border border-gray-300 p-3 text-left font-semibold">Data</th>
              <th class="border border-gray-300 p-3 text-left font-semibold">Full Payload</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- JavaScript logic -->
  <script>
    // Initialize Vue.js for navigation
    const { createApp } = Vue;
    createApp({
      data() {
        return { view: 'tools' };
      },
      methods: {
        navigate(section) {
          this.view = section;
          trackNavigation(section);
          window.clarity('event', `navigation_${section}`);
          window.dataLayer.push({ event: 'ppms.cm:navigation', section });
        }
      }
    }).mount('#nav-app');

    // --- Alloy Payload Analyzer GA4 Enhanced Tracking ---

    // Tool loaded/session started (fires once at load)
    gtag('event', 'tool_loaded', {
      tool_name: 'Alloy Payload Analyzer',
      tool_version: '1.1.0',
      page_location: window.location.href
    });

    // Heartbeat for active engagement (fires every 30 seconds)
    setInterval(() => {
      gtag('event', 'tool_heartbeat', {
        tool_name: 'Alloy Payload Analyzer',
        timestamp: new Date().toISOString()
      });
    }, 30000);

    // Tracking functions
    function trackJsonParsed(payloads) {
      gtag('event', 'json_parsed', {
        payload_count: payloads.length,
        event_types: Array.from(new Set(payloads.map(e => e.eventType || 'unknown'))).join(','),
        tool_name: 'Alloy Payload Analyzer'
      });
    }

    function trackJsonDownload(payloads) {
      gtag('event', 'json_download', {
        payload_count: payloads.length,
        event_types: Array.from(new Set(payloads.map(e => e.eventType || 'unknown'))).join(','),
        tool_name: 'Alloy Payload Analyzer'
      });
    }

    function trackScriptCopied() {
      gtag('event', 'script_copied', {
        tool_name: 'Alloy Payload Analyzer'
      });
    }

    function trackFilterUsed(filter) {
      gtag('event', 'filter_used', {
        filter_value: filter,
        tool_name: 'Alloy Payload Analyzer'
      });
    }

    function trackNavigation(section) {
      gtag('event', 'navigation_click', {
        section,
        tool_name: 'Alloy Payload Analyzer'
      });
    }

    function trackToolError(e) {
      gtag('event', 'tool_error', {
        error_type: e.name || 'Error',
        error_message: e.message || 'Unknown',
        tool_name: 'Alloy Payload Analyzer'
      });
    }

    // Debounce utility
    function debounce(fn, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    // Alloy monitor
    window.__alloyMonitors = window.__alloyMonitors || [];
    window.__alloyMonitors.push({
      onBeforeNetworkRequest(data) {
        const key = 'alloyEventPayloads';
        const existing = sessionStorage.getItem(key);
        const payloads = existing ? JSON.parse(existing) : [];
        const event = data?.payload?.events?.[0];
        if (event) {
          payloads.push(event);
          sessionStorage.setItem(key, JSON.stringify(payloads));
          gtag('event', 'payload_captured', { event_type: event.eventType || 'unknown' });
          window.clarity('event', 'payload_captured');
          window.dataLayer.push({ event: 'ppms.cm:payload_captured', event_type: event.eventType || 'unknown' });
        } else {
          console.warn('[Alloy Monitor] No events[0] found in payload:', data.payload);
        }
      },
      onCommandResolved(data) {
        console.log("Command Resolved:", data);
      },
      onNetworkResponse(data) {
        console.log("Network Response:", data);
      },
      onNetworkError(data) {
        console.warn("Network Error:", data);
        gtag('event', 'network_error', { error: data.error });
        window.clarity('event', 'network_error');
        window.dataLayer.push({ event: 'ppms.cm:network_error', error: data.error });
      }
    });

    // Recursively render nested objects
    function renderNestedObject(obj, depth = 0) {
      if (!obj || typeof obj !== 'object') {
        return String(obj || 'N/A');
      }
      let html = '<ul class="nested-indent">';
      Object.entries(obj).forEach(([key, value]) => {
        const id = `nested-${Math.random().toString(36).slice(2)}`;
        const isWebField = key === 'web' && depth === 1;
        const className = isWebField ? 'bg-blue-100' : '';
        if (typeof value === 'object' && value !== null) {
          html += `<li class="${className}">${key}: <span class="text-blue-500 cursor-pointer hover:underline" onclick="toggleNested('${id}')" aria-expanded="false" aria-controls="${id}">[Object]</span><pre id="${id}" class="bg-gray-50 p-2 rounded hidden">${renderNestedObject(value, depth + 1)}</pre></li>`;
        } else {
          html += `<li class="${className}">${key}: ${value}</li>`;
        }
      });
      html += '</ul>';
      return html;
    }

    // Parse and render payloads
    function parsePayloads() {
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const payloadInput = document.getElementById('payloadInput');
      errorMessage.classList.add('hidden');
      successMessage.classList.add('hidden');
      loadingIndicator.classList.remove('hidden');

      const input = payloadInput.value.trim();
      if (!input) {
        errorMessage.textContent = 'Error: Input is empty. Please paste a valid JSON array or object of events.';
        errorMessage.classList.remove('hidden');
        gtag('event', 'parse_payloads', { status: 'failure', error: 'empty_input' });
        window.clarity('event', 'parse_payloads_failure');
        window.dataLayer.push({ event: 'ppms.cm:parse_payloads', status: 'failure', error: 'empty_input' });
        trackToolError({ name: 'Error', message: 'Empty input' });
        loadingIndicator.classList.add('hidden');
        return;
      }

      try {
        let payloads = JSON.parse(input);
        // Convert single object to array if valid
        if (!Array.isArray(payloads) && typeof payloads === 'object' && payloads !== null) {
          payloads = [payloads];
        }
        if (!Array.isArray(payloads)) {
          throw new Error('Input must be a JSON array or a single object convertible to an array of events');
        }
        if (payloads.length === 0) {
          throw new Error('Input array is empty. Please provide at least one event.');
        }
        document.getElementById('downloadBtn').classList.remove('hidden');
        renderTable(payloads);
        successMessage.textContent = `Successfully parsed ${payloads.length} events.`;
        successMessage.classList.remove('hidden');
        trackJsonParsed(payloads);
        window.clarity('event', 'parse_payloads_success');
        window.dataLayer.push({
          event: 'ppms.cm:parse_payloads',
          status: 'success',
          payload_count: payloads.length,
          event_types: payloads.map(e => e.eventType || 'unknown').join(',')
        });
        return payloads;
      } catch (e) {
        console.error('Parse error details:', e);
        errorMessage.textContent = e.name === 'SyntaxError'
          ? 'Invalid JSON syntax. Check for missing brackets, commas, or invalid characters and try again.'
          : `Error: ${e.message}. Ensure the input is a valid JSON array or object of events.`;
        errorMessage.classList.remove('hidden');
        trackToolError(e);
        gtag('event', 'parse_payloads', { status: 'failure', error: e.name === 'SyntaxError' ? 'syntax_error' : e.message });
        window.clarity('event', 'parse_payloads_failure');
        window.dataLayer.push({
          event: 'ppms.cm:parse_payloads',
          status: 'failure',
          error: e.name === 'SyntaxError' ? 'syntax_error' : e.message
        });
        payloadInput.value = input; // Retain input on error
        return null;
      } finally {
        loadingIndicator.classList.add('hidden');
      }
    }

    // Refresh payloads from sessionStorage
    function refreshPayloads() {
      const key = 'alloyEventPayloads';
      const stored = sessionStorage.getItem(key);
      const payloadInput = document.getElementById('payloadInput');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      const loadingIndicator = document.getElementById('loadingIndicator');
      errorMessage.classList.add('hidden');
      successMessage.classList.add('hidden');
      loadingIndicator.classList.remove('hidden');

      if (!stored) {
        errorMessage.textContent = 'No payloads found in sessionStorage. Ensure the Alloy monitor is running.';
        errorMessage.classList.remove('hidden');
        gtag('event', 'refresh_payloads', { status: 'failure', error: 'no_payloads' });
        window.clarity('event', 'refresh_payloads_failure');
        window.dataLayer.push({ event: 'ppms.cm:refresh_payloads', status: 'failure', error: 'no_payloads' });
        trackToolError({ name: 'Error', message: 'No payloads in sessionStorage' });
        loadingIndicator.classList.add('hidden');
        return;
      }

      payloadInput.value = stored;
      parsePayloads();
      gtag('event', 'refresh_payloads', { status: 'success' });
      window.clarity('event', 'refresh_payloads_success');
      window.dataLayer.push({ event: 'ppms.cm:refresh_payloads', status: 'success' });
      loadingIndicator.classList.add('hidden');
    }

    // Render table with multiple columns based on nested payload structure
    function renderTable(events) {
      const tbody = document.querySelector('#payloadTable tbody');
      tbody.innerHTML = '';

      events.forEach((event, index) => {
        const row = document.createElement('tr');

        // Extract nested fields with safe access
        const eventType = event.eventType || event.xdm?.eventType || 'N/A';
        const timestamp = event.xdm?.timestamp ? new Date(event.xdm.timestamp).toLocaleString() : 'N/A';
        const pageURL = event.xdm?.web?.webPageDetails?.URL || 'N/A';
        const pageName = event.xdm?.web?.webPageDetails?.name || 'N/A';
        const interaction = event.xdm?.web?.webInteraction?.name || 'N/A';

        // Handle data field (render as nested object or string)
        let dataContent = 'N/A';
        if (event.data && typeof event.data === 'object') {
          const dataId = `data-nested-${Math.random().toString(36).slice(2)}`;
          dataContent = `<span class="text-blue-500 cursor-pointer hover:underline" onclick="toggleNested('${dataId}')" aria-expanded="false" aria-controls="${dataId}">[Object]</span><pre id="${dataId}" class="bg-gray-50 p-2 rounded hidden">${renderNestedObject(event.data, 1)}</pre>`;
        } else if (event.data) {
          dataContent = String(event.data);
        }

        // Full payload for detailed inspection
        const fullPayloadId = `full-payload-${Math.random().toString(36).slice(2)}`;
        const fullPayloadContent = `<span class="text-blue-500 cursor-pointer hover:underline" onclick="toggleNested('${fullPayloadId}')" aria-expanded="false" aria-controls="${fullPayloadId}">[Object]</span><pre id="${fullPayloadId}" class="bg-gray-50 p-2 rounded hidden">${renderNestedObject(event, 1)}</pre>`;

        // Populate row with column data
        row.innerHTML = `
          <td class="border border-gray-300 p-3">${eventType}</td>
          <td class="border border-gray-300 p-3">${timestamp}</td>
          <td class="border border-gray-300 p-3">${pageURL}</td>
          <td class="border border-gray-300 p-3">${pageName}</td>
          <td class="border border-gray-300 p-3">${interaction}</td>
          <td class="border border-gray-300 p-3">${dataContent}</td>
          <td class="border border-gray-300 p-3">${fullPayloadContent}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Toggle nested object visibility
    function toggleNested(id) {
      const el = document.getElementById(id);
      const trigger = document.querySelector(`[aria-controls="${id}"]`);
      const isHidden = el.classList.contains('hidden');
      el.classList.toggle('hidden');
      trigger.setAttribute('aria-expanded', isHidden);
      gtag('event', 'toggle_nested', { state: isHidden ? 'expanded' : 'collapsed', element_id: id });
      window.clarity('event', `toggle_nested_${isHidden ? 'expanded' : 'collapsed'}`);
      window.dataLayer.push({ event: 'ppms.cm:toggle_nested', state: isHidden ? 'expanded' : 'collapsed', element_id: id });
    }

    // Filter table rows
    const filterTable = debounce(() => {
      const filter = document.getElementById('filterInput').value.toLowerCase();
      const rows = document.querySelectorAll('#payloadTable tbody tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
      });
      trackFilterUsed(filter);
      window.clarity('event', 'filter_table');
      window.dataLayer.push({ event: 'ppms.cm:filter_table', filter_value: filter });
    }, 300);

    // Download payloads as JSON
    function downloadJSON() {
      const input = document.getElementById('payloadInput').value;
      const payloads = parsePayloads();
      if (payloads) {
        const blob = new Blob([JSON.stringify(payloads, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'alloy_payloads.json';
        a.click();
        URL.revokeObjectURL(url);
        trackJsonDownload(payloads);
        window.clarity('event', 'download_json');
        window.dataLayer.push({ event: 'ppms.cm:download_json', payload_count: payloads.length });
      }
    }

    // Copy script to clipboard
    function copyScript() {
      const scriptText = document.getElementById('alloyScript').textContent;
      navigator.clipboard.writeText(scriptText).then(() => {
        const successMessage = document.getElementById('successMessage');
        successMessage.textContent = 'Script copied to clipboard!';
        successMessage.classList.remove('hidden');
        setTimeout(() => successMessage.classList.add('hidden'), 3000);
        trackScriptCopied();
        window.clarity('event', 'copy_script_success');
        window.dataLayer.push({ event: 'ppms.cm:copy_script', status: 'success' });
      }).catch(err => {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = 'Failed to copy script. Please select and copy manually.';
        errorMessage.classList.remove('hidden');
        console.error('Copy failed:', err);
        trackToolError(err);
        gtag('event', 'copy_script', { status: 'failure', error: err.message });
        window.clarity('event', 'copy_script_failure');
        window.dataLayer.push({ event: 'ppms.cm:copy_script', status: 'failure', error: err.message });
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      refreshPayloads();
      document.getElementById('filterInput').addEventListener('input', filterTable);
    });
  </script>
</body>
</html>
